# 自动瞄准系统
系统主要模块包括：
- **检测模块**：负责图像预处理和装甲板识别
- **追踪模块**：管理目标追踪状态和生命周期
- **EKF运动建模模块**：使用卡尔曼滤波进行状态估计和预测

## 检测模块

### 实现方法
检测模块主要由 `Detector` 类实现，采用传统计算机视觉方法进行装甲板识别：

1. **图像预处理**：将输入图像转换为灰度图，并通过阈值分割得到二值图像，便于后续轮廓提取。
2. **灯条检测**：使用 `cv::findContours` 提取轮廓，对每个轮廓计算最小外接矩形，筛选出符合灯条特征的候选区域（长宽比、角度、面积等）。
3. **装甲板匹配**：将相邻灯条配对，计算匹配评分（基于位置、角度、尺寸等），选择最佳配对形成装甲板。

## 追踪模块

### 实现方法
追踪模块由 `Tracker` 类实现，采用状态机管理追踪过程，并集成 `PnpSolver` 进行三维位置解算：

1. **状态管理**：使用状态机控制追踪状态（lost、detecting、tracking、temp_lost、switching），根据检测计数和丢失计数进行状态转换。

2. **目标初始化**：在lost状态下，通过 `set_target` 创建新目标。首先调用 `PnpSolver` 的 `_solve_pnp` 方法对检测到的装甲板进行PnP解算，计算其在相机坐标系（p_camera）、云台坐标系（p_gimbal）和世界坐标系（p_world）下的位置，以及yaw、pitch等角度。然后初始化EKF滤波器，使用解算出的位置和角度作为初始状态。

3. **目标更新**：在tracking状态下，通过 `update_target` 更新现有目标状态。遍历检测到的装甲板，筛选出与当前目标车号匹配的装甲板，再次调用 `PnpSolver` 的 `_solve_pnp` 进行解算，更新EKF状态。

4. **PnP解算器功能**：`PnpSolver` 类负责从2D图像点解算3D位置。`_solve_pnp` 方法首先提取装甲板角点，使用OpenCV的 `solvePnP` 函数计算旋转向量和平移向量，然后通过坐标变换得到世界坐标系下的位置和角度。自定义函数 `optimize_yaw` 通过最小化重投影误差优化yaw角度，其逻辑是遍历yaw候选值，计算每个值下的重投影误差，选择误差最小的yaw。 函数计算重投影误差，通过将3D点投影回2D并与实际角点比较距离。
## EKF运动建模模块

### 实现方法
EKF运动建模由 `Ekf` 类实现，使用扩展卡尔曼滤波进行状态估计：

1. **状态向量**：针对装甲板旋转中心建模的11维向量，包含目标位置（x, y, z）、速度（vx, vy, vz）、角度（a）、角速度（w）以及装甲板尺寸参数（r, l, h），其中r为半径，l为长轴与短轴差，h为高度差。

2. **观测向量**：针对装甲板建模的4维向量，包含yaw角度、pitch角度、距离和角度测量值（具体为ypd[0]、ypd[1]、ypd[2]、ypr[0]），通过PnP解算从装甲板图像点获得。

3. **协方差矩阵**：
   - **初始协方差P0**：对角矩阵，设置位置和速度的初始不确定性。
   - **预测协方差P**：通过预测步骤更新，反映当前状态的不确定性。
   - **过程噪声协方差Q**：矩阵形式，基于常速度模型，考虑加速度噪声v1和角加速度噪声v2，通过离散时间积分计算。
   - **观测噪声协方差R**：对角矩阵，根据测量值动态调整。

4. **预测步骤**：使用状态转移矩阵F和过程噪声Q进行状态预测，采用常速度模型。

5. **更新步骤**：通过观测矩阵H和观测噪声R，将观测向量融入状态估计，使用卡尔曼增益计算更新。

6. **非线性处理**：使用自定义的加法函数处理角度等周期性变量，避免异常值。